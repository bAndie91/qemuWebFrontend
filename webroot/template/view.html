<div id=qemu_view>

State:
	<b>
	<span class="vmstate_on" style="display: none;">ON</span>
	<span class="vmstate_off" style="display: none;">OFF</span>
	</b>

	<span class="vmstate_off" style="display: none;">
		<input type=button onClick="qemu.act('start', {}, '{$vm.name}'); refresh_state();" value="start" />
	</span>
	<span class="vmstate_paused" style="display: none;">
		<input type=button onClick="qemu.act('resume', {}, '{$vm.name}'); refresh_state();" value="resume" />
	</span>
	<span class="vmstate_unpaused" style="display: none;">
		<input type=button onClick="qemu.act('pause', {}, '{$vm.name}'); refresh_state();" value="pause" />
	</span>
	<span class="vmstate_on" style="display: none;">
		<input type=button onClick="qemu.act('shutdown', {}, '{$vm.name}'); refresh_state();" value="shutdown" />
		<input type=button onClick="qemu.act('poweroff', {}, '{$vm.name}'); refresh_state();" value="poweroff" />
		<input type=button onClick="qemu.act('reset', {}, '{$vm.name}'); refresh_state();" value="reset" />
	</span>
	<a href="?act=new&copy={$vm.name}">copy</a>
	<a href="?act=edit&name={$vm.name}">edit</a>
	<a href="?act=view&name={$vm.name}">view</a>
	<br/>
	
	<input type=button id=btn_refresh value="Refresh" onClick="refresh_state({refresh_screenshot: true});" />
	<span id="refresh_progress" style="display: none;">dispatching...</span>
<br/>

<div id=preview>
	<i>Screenshot Time:</i>
	<span id=screenshot_time></span>
	
	<div>
	<img id=screenshot />
	<span id=no_screenshot>no preview</span>
	</div>
	
	<div>
		Typing here goes to VM:<br/>
		buffer length: <span id=buffer_length>0</span><br/>
		{include="keyboard"}
	</div>
	<div class=clear></div>
</div>
</div>

<script type="text/javascript">
document.qemuvm = { name: '{$vm.name}' };
document.keyBuffer = [];
document.modKeys = {alt:false, alt_r:false, altgr:false, altgr_r:false, ctrl:false, ctrl_r:false, meta:false, meta_r:false, shift:false, shift_r:false};

function refresh_state(param)
{
	qemu.refresh_state(document.qemuvm, {
		progress_indicator: $('#refresh_progress'),
		
		state_on: $('.vmstate_on'),
		state_off: $('.vmstate_off'),
		state_paused: $('.vmstate_paused'),
		state_unpaused: $('.vmstate_unpaused'),
		
		enable_on: $('#notepad, #keyboard input'),
		enable_off: $(null),
		enable_paused: $(null),
		enable_unpaused: $('#notepad, #keyboard input'),
		
		screenshot: {
			img: $('#screenshot'), 
			show: $('#screenshot'), 
			hide: $('#no_screenshot'), 
			time: $('#screenshot_time'),
		},
	},
	param);
}

function sendKeys()
{
	qemu.act("event", {event: "key", keys: document.keyBuffer}, '{$vm.name}');
	document.keyBuffer = [];
	$('#buffer_length').text(0);
	refresh_screenshot();
}

function keyEvent(event)
{
	if(event == undefined) return;
	
	if(document.keyTimeout != undefined) clearTimeout(document.keyTimeout);
	document.keyBuffer.push(event);
	$('#buffer_length').text( $('#buffer_length').text()*1+1 );
	document.keyTimeout = setTimeout(sendKeys, 1000);
}

function specKey(name)
{
	var a = {};
	a.keyName = name;
	for(var mk in document.modKeys)
	{
		if(document.modKeys[mk]) a[mk] = 1;
	}
	keyEvent(a);
	$('#notepad').focus();
}

function modKey(name, button)
{
	if(document.modKeys[name])
	{
		document.modKeys[name] = false;
		$(button).removeClass('hold');
	}
	else
	{
		document.modKeys[name] = true;
		$(button).addClass('hold');
	}
	$('#notepad').focus();
}

function refresh_screenshot()
{
	qemu.refresh_screenshot(document.qemuvm, {screenshot: {img: $('#screenshot'), show: $('#screenshot'), hide: $('#no_screenshot'), time: $('#screenshot_time')}});
}

$(document).ready(function()
{
	refresh_state();
	
	$('#screenshot').click(function(event)
	{
		qemu.act("event", {event: "click", pos: {x: event.offsetX, y: event.offsetY}, button: {left: true}}, '{$vm.name}');
		refresh_screenshot();
	});

	$('#notepad').keypress(function(event)
	{
		var a = {keyCode: event.keyCode};
		for(var mk in document.modKeys)
		{
			var p = mk + 'Key';
			if(event[p] || document.modKeys[mk]) a[mk] = 1;
		}
		keyEvent(a);
		
		if(event.keyCode == 27) this.value = '';
		if((event.keyCode >= 0x30 && event.keyCode <= 0x39) || 
		   (event.keyCode >= 0x41 && event.keyCode <= 0x5A) || 
		   (event.keyCode >= 0x61 && event.keyCode <= 0x7A) ||  // >
		   event.keyCode == 0x20 ||
		   event.keyCode == 0x08 || event.keyCode == 0x0D)
		{
		}
		else
		{
			event.preventDefault();
		}
	});
	$('#notepad').focus(function()
	{
		this.value = '';
	});
});

</script>
