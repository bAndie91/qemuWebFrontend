<div id=qemu_view>

State:
	<span class="vmstate_on" style="display: none;">ON</span>
	<span class="vmstate_off" style="display: none;">OFF</span>
	<input type=button id=btn_refresh value="Refresh" />
<br/>
	<span class="vmstate_off">
		<input type=button onClick="qemu.act('start', {}, '{$vm.name}'); refresh_state();" value="start" />
	</span>
	<span class="vmstate_paused" style="display: none;">
		<input type=button onClick="qemu.act('resume', {}, '{$vm.name}'); refresh_state();" value="resume" />
	</span>
	<span class="vmstate_unpaused" style="display: none;">
		<input type=button onClick="qemu.act('pause', {}, '{$vm.name}'); refresh_state();" value="pause" />
	</span>
	<span class="vmstate_on">
		<input type=button onClick="qemu.act('shutdown', {}, '{$vm.name}');" value="shutdown" />
		<input type=button onClick="qemu.act('poweroff', {}, '{$vm.name}'); refresh_state();" value="poweroff" />
		<input type=button onClick="qemu.act('reset', {}, '{$vm.name}');" value="reset" />
	</span>
	<a href="?act=new&copy={$vm.name}">copy</a>
	<a href="?act=edit&name={$vm.name}">edit</a>
	<a href="?act=view&name={$vm.name}">view</a>
<br/>

<div id=preview>
	<div style="float: left;"><h3>Preview</h3></div>
	<div style="float: right;">Time: <span id=screenshot_time>{$vm.screenshot.timestr}</span></div>
	<div class=clear></div>
	
	<div style="float: left;">
	{if="isset($vm.screenshot.url)"}
		<img src="{$vm.screenshot.url}?ts={$vm.screenshot.timestamp}#" id=screenshot />
	{else}
		<span id=no_screenshot>no preview</span>
	{/if}
	</div>
	<div style="float: right;">
	Typing here goes to VM:<br/>
	<textarea id=notepad></textarea>
	</div>
	<div class=clear></div>
</div>
</div>

<script type="text/javascript">
document.qemuvm = { name: '{$vm.name}' };
document.keyBuffer = [];

function refresh_state(param)
{
	qemu.refresh_state(document.qemuvm, {
		state_on: $('.vmstate_on'),
		state_off: $('.vmstate_off'),
		state_paused: $('.vmstate_paused'),
		state_unpaused: $('.vmstate_unpaused'),
	});
	if(param && param.refresh_screenshot && document.qemuvm.state.running)
	{
		qemu.screenshot('{$vm.name}', {img: $('#screenshot'), noimg: $('#no_screenshot'), time: $('#screenshot_time')});
	}
}

function sendkeys()
{
	qemu.act("event", {event: "key", keys: document.keyBuffer}, '{$vm.name}');
	document.keyBuffer = [];
	qemu.screenshot('{$vm.name}', {img: $('#screenshot'), noimg: $('#no_screenshot'), time: $('#screenshot_time')});
}

$(document).ready(function()
{
	$('#btn_refresh').click(function(){ refresh_state({refresh_screenshot: true}); });

	refresh_state();
	
	$('#screenshot').click(function(event)
	{
		qemu.act("event", {event: "click", x: offsetX, y: offsetY}, '{$vm.name}');
	});

	$('#notepad').keypress(function(event)
	{
		if(document.keyTimeout != undefined) clearTimeout(document.keyTimeout);
		var a = {keyCode: event.keyCode};
		if(event.altKey) a.altKey = 1;
		if(event.ctrlKey) a.ctrlKey = 1;
		if(event.metaKey) a.metaKey = 1;
		if(event.shiftKey) a.shiftKey = 1;
		document.keyBuffer.push(a);
		document.keyTimeout = setTimeout(sendkeys, 1000);
		
		if((event.keyCode >= 0x30 && event.keyCode <= 0x39) || 
		   (event.keyCode >= 0x41 && event.keyCode <= 0x5A) || 
		   (event.keyCode >= 0x61 && event.keyCode <= 0x7A) || 
		   event.keyCode == 8 || event.keyCode == 13) return true;
		return false;
	});
});

</script>
